<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>サーバーサイドハッシュ化掲示板</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
        }
        #post-form {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        #post-form input[type="text"],
        #post-form input[type="password"],
        #post-form textarea {
            width: calc(100% - 22px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            box-sizing: border-box;
        }
        #post-form button {
            padding: 8px 15px;
            background-color: #eee;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        .post {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }
        .post .author {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .post .content {
            white-space: pre-wrap; /* 改行を保持 */
        }
    </style>
</head>
<body>
    <h1>サーバーサイドハッシュ化掲示板</h1>

    <div id="post-form">
        <input type="text" id="name" placeholder="名前">
        <input type="password" id="password" placeholder="パスワード">
        <textarea id="message" rows="4" placeholder="メッセージ"></textarea>
        <button onclick="addPost()">投稿</button>
    </div>

    <h2>投稿一覧</h2>
    <div id="post-list">
        </div>

    <script>
        const postList = document.getElementById('post-list');
        const nameInput = document.getElementById('name');
        const passwordInput = document.getElementById('password');
        const messageInput = document.getElementById('message');
        const API_ENDPOINT = 'api.php';

        const storedName = localStorage.getItem('bbsName');
        const storedPassword = localStorage.getItem('bbsPassword');

        if (storedName) {
            nameInput.value = storedName;
        }
        if (storedPassword) {
            passwordInput.value = storedPassword;
        }

        async function addPost() {
            const name = nameInput.value.trim();
            const password = passwordInput.value;
            const message = messageInput.value.trim();

            if (name && password && message) {
                localStorage.setItem('bbsName', name);
                localStorage.setItem('bbsPassword', password);

                const formData = new FormData();
                formData.append('name', name);
                formData.append('password', password);
                formData.append('message', message);

                try {
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        alert(data.message);
                        messageInput.value = '';
                        loadPosts();
                    } else {
                        const errorData = await response.json();
                        alert(`投稿に失敗しました: ${errorData.error || '不明なエラー'}`);
                    }
                } catch (error) {
                    console.error('投稿エラー:', error);
                    alert('投稿中にエラーが発生しました。');
                }
            } else {
                alert('名前、パスワード、メッセージを入力してください。');
            }
        }

        async function loadPosts() {
            try {
                const response = await fetch(API_ENDPOINT);
                if (response.ok) {
                    const posts = await response.json();
                    postList.innerHTML = '';
                    posts.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.classList.add('post');
                        postDiv.innerHTML = `
                            <div class="author">${escapeHtml(post.name)}</div>
                            <div class="content">${escapeHtml(post.message)}</div>
                            <small>投稿日時: ${escapeHtml(post.timestamp)} / ID: ${escapeHtml(post.id)}</small>
                        `;
                        postList.prepend(postDiv);
                    });
                } else {
                    console.error('投稿の読み込みに失敗しました。');
                }
            } catch (error) {
                console.error('投稿読み込みエラー:', error);
            }
        }

        // 初回ロード時に投稿を読み込む
        loadPosts();

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
         }
    </script>
</body>
</html>
